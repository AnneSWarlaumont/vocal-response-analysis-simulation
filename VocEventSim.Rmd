---
title: "Simulating infant and adult vocalization events"
author: "Anne S. Warlaumont"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

(This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.)

# Set rthresh
```{r}
rthresh = 1
#rthresh = 5
```

<!-- ## Simulate 5 minutes of infant vocal events -->

<!-- The approach is inspired by this paper: https://doi.org/10.1080/15427951.2004.10129088 -->

<!-- Sampling from a binomial distribution where probability of vocalizing is multiplied at each 1 s time step by a random lognormal value (mu = 0.02 and sigma = 0.2), with an enforcement that the probability of vocalizing should stay between .002 and .2: -->

<!-- ```{r} -->
<!-- sim_length = 5*60 # in 1-second time steps -->
<!-- p_voc = .02 -->
<!-- voc_record = c() -->
<!-- for (t in 1:sim_length){ -->
<!--   voc_event = rbinom(1,1,p_voc) -->
<!--   voc_record = c(voc_record,voc_event) -->
<!--   p_voc_multiplier = rlnorm(1,meanlog = .02,sdlog = .2) -->
<!--   p_voc = max(.002,min(.2,p_voc_multiplier * p_voc)) -->
<!-- } -->
<!-- print(voc_record) -->
<!-- ``` -->

## Simulate 10 hr of infant vocalizations, with contingent adult vocal events also in the simulation

Have adults vocalize in a similar manner, but in such a way that their probability of vocalizing increases a bit each time the infant vocalizes and they do not vocalize if the infant is already vocalizing at that second:

```{r}
sim_length = 10*60*60 # 10 hours in 1-second time steps
p_i_voc = .02
p_a_voc = .02
i_voc_record = c()
a_voc_record = c()
for (t in 1:sim_length){
  
  i_voc_event = rbinom(1,1,p_i_voc)
  i_voc_record = c(i_voc_record,i_voc_event)
  p_i_voc_multiplier = rlnorm(1,meanlog = .02,sdlog = .2)
  p_i_voc = max(.002,min(.2,p_i_voc_multiplier * p_i_voc))
  
  if (i_voc_event==1){
    p_a_voc = p_a_voc*100
    a_voc_event = 0
  } else{
    a_voc_event = rbinom(1,1,p_a_voc)
  }
  a_voc_record = c(a_voc_record,a_voc_event)
  p_a_voc_multiplier = rlnorm(1,meanlog = .02,sdlog = .2)
  p_a_voc = max(.002,min(.2,p_a_voc_multiplier * p_a_voc))
}
print(i_voc_record[1:(5*60)])
print(paste("total infant vocalization count: ",sum(i_voc_record)))
print(a_voc_record[1:(5*60)])
print(paste("total adult vocalization count: ",sum(a_voc_record)))
```

## Which infant vocalizations were followed by adult responses?

Calculate how many infant vocalizations were followed within rthresh s by an adult vocalization

```{r}
atoi_r_record = c()
for (t in 1:(sim_length-rthresh)){
  if (i_voc_record[t] == 1){
    if (sum(a_voc_record[(t+1):(t+rthresh)])>0){
      atoi_r_record = c(atoi_r_record,1)
    }else{
      atoi_r_record = c(atoi_r_record,0)
    }
  }else{
    atoi_r_record = c(atoi_r_record,NA)
  }
}
atoi_r_count = sum(atoi_r_record,na.rm=TRUE)
print(paste("response window: ",rthresh))
print(atoi_r_record[1:(5*60)])
print(paste("total adult response to infant count:",atoi_r_count))
```

## Which adult vocalizations were followed by infant responses?

```{r}
itoa_r_record = c()
for (t in 1:(sim_length-rthresh)){
  if (a_voc_record[t] == 1){
    if (sum(i_voc_record[(t+1):(t+rthresh)])>0){
      itoa_r_record = c(itoa_r_record,1)
    }else{
      itoa_r_record = c(itoa_r_record,0)
    }
  }else{
    itoa_r_record = c(itoa_r_record,NA)
  }
}
itoa_r_count = sum(itoa_r_record,na.rm=TRUE)
print(paste("response window: ",rthresh))
print(itoa_r_record[1:(5*60)])
print(paste("total infant response to count:",itoa_r_count))
```

## Get infant inter-vocalization intervals and whether they are with response or without response steps, and the median and 90th percentile values for the wr and wor steps. Exclude steps (setting wr to NA in those cases) where the infant ivi was <= rthresh (because then the adult couldn't have responded, because they were restricted from overlapping an infant voc).
```{r}
i_ivi_record = c()
i_ivi_wr_record = c()
i1 = NA
i2 = NA
for (t in 1:sim_length){
  if (is.na(i1) & i_voc_record[t]==1){
    i1 = t
  } else if (i_voc_record[t]==1){
    
    i2 = t
    ivi = i2-i1
    i_ivi_record = c(i_ivi_record,ivi)
    
    if (ivi<=rthresh){
      i_ivi_wr_record = c(i_ivi_wr_record,NA)
    }else if (atoi_r_record[i1]==1){
      i_ivi_wr_record = c(i_ivi_wr_record,1)
    }else{
      i_ivi_wr_record = c(i_ivi_wr_record,0)
    }
    
    i1 = i2
  }
}
print(i_ivi_record[1:(5*60)])
print(i_ivi_wr_record[1:(5*60)])
i_ivi_minlength_record = i_ivi_record[i_ivi_record>rthresh+1]
i_ivi_minlength_wr_record = i_ivi_wr_record[i_ivi_record>rthresh+1]
i_ivi_wr_median = median(i_ivi_minlength_record[i_ivi_minlength_wr_record==1])
i_ivi_wor_median = median(i_ivi_minlength_record[i_ivi_minlength_wr_record!=1])
i_ivi_wr_90pct = quantile(i_ivi_minlength_record[i_ivi_minlength_wr_record==1],probs=.9,na.rm=TRUE)
i_ivi_wor_90pct = quantile(i_ivi_minlength_record[i_ivi_minlength_wr_record!=1],probs=.9,na.rm=TRUE)
print(i_ivi_wr_median)
print(i_ivi_wor_median)
print(i_ivi_wr_90pct)
print(i_ivi_wor_90pct)
```

## Perform uncontrolled analysis testing whether WR IVIs are shorter than WOR IVIs
```{r}
i_ivi_wr_fit = lm(scale(i_ivi_record)~i_ivi_wr_record)
summary(i_ivi_wr_fit)
i_ivi_wr_log_fit = lm(scale(log(i_ivi_record))~i_ivi_wr_record)
summary(i_ivi_wr_log_fit)
```

## Find and plot the relationship between the current infant IVI and the previous infant IVI
```{r}
n_i_ivi = length(i_ivi_record)
plot(log(i_ivi_record[1:n_i_ivi-1]),log(i_ivi_record[2:n_i_ivi]))
i_ivi_fit = lm(scale(log(i_ivi_record[2:n_i_ivi]))~scale(log(i_ivi_record[1:n_i_ivi-1])))
#i_ivi_fit = lm(scale(log(i_ivi_record[4:n_i_ivi]))~scale(log(i_ivi_record[1:(n_i_ivi-3)]))+scale(log(i_ivi_record[2:(n_i_ivi-2)]))+scale(log(i_ivi_record[3:(n_i_ivi-1)])))
abline(i_ivi_fit)
summary(i_ivi_fit)
```

## Get the residuals of of that fit, indicating if the current infant IVI is longer or shorter than expected given the previous infant IVI
```{r}
i_ivi_res = resid(i_ivi_fit)
```

# See if the residuals of the prediction of current IVI based on previous IVI show a pattern where wr IVIs are shorter than wor IVIs controlling for the persistence of IVI
```{r}
i_ivi_res_fit = lm(scale(i_ivi_res[1:length(i_ivi_res-1)])~scale(i_ivi_wr_record[2:length(i_ivi_wr_record-1)]),na.action=na.omit)
#i_ivi_res_fit = lm(scale(i_ivi_res[1:length(i_ivi_res-1)])~scale(i_ivi_wr_record[4:length(i_ivi_wr_record-1)]),na.action=na.omit)
summary(i_ivi_res_fit)
```

<!-- ## Get adult inter-vocalization intervals -->
<!-- ```{r} -->
<!-- a_ivi_record = c() -->
<!-- i1 = NA -->
<!-- i2 = NA -->
<!-- for (t in 1:sim_length){ -->
<!--   if (is.na(i1) & a_voc_record[t]==1){ -->
<!--     i1 = t -->
<!--   } else if (a_voc_record[t]==1){ -->
<!--     i2 = t -->
<!--     ivi = i2-i1 -->
<!--     a_ivi_record = c(a_ivi_record,ivi) -->
<!--     i1 = i2 -->
<!--   } -->
<!-- } -->
<!-- print(a_ivi_record) -->
<!-- ``` -->

## Have infant vocalizations increase in probability following an adult response

```{r}
sim_length = 10*60*60 # 10 hours in 1-second time steps
p_i_voc = .02
p_a_voc = .02
i_voc_record = c()
a_voc_record = c()
atoi_r_record = c()
itoa_r_record = c()
for (t in 1:sim_length){
  
  i_voc_event = rbinom(1,1,p_i_voc)
  i_voc_record = c(i_voc_record,i_voc_event)
  p_i_voc_multiplier = rlnorm(1,meanlog = .02,sdlog = .2)
  p_i_voc = max(.002,min(.2,p_i_voc_multiplier * p_i_voc))
  
  if (i_voc_event==1){
    p_a_voc = max(.002,min(.2,p_a_voc*100))
    a_voc_event = 0
  } else{
    a_voc_event = rbinom(1,1,p_a_voc)
  }
  a_voc_record = c(a_voc_record,a_voc_event)
  p_a_voc_multiplier = rlnorm(1,meanlog = .02,sdlog = .2)
  p_a_voc = max(.002,min(.2,p_a_voc_multiplier * p_a_voc))
  
  if (t>rthresh){
    
    # Record when the adult responded to the infant
    if (i_voc_record[t-rthresh] == 1){
      if (sum(a_voc_record[(t-rthresh+1):t])>0){
        atoi_r_record = c(atoi_r_record,1)
      }else{
        atoi_r_record = c(atoi_r_record,0)
      }
    }else{
      atoi_r_record = c(atoi_r_record,NA)
    }
    
    # Record when the infant responded to the adult
    if (a_voc_record[t-rthresh] == 1){
      if (sum(i_voc_record[(t-rthresh+1):t])>0){
        itoa_r_record = c(itoa_r_record,1)
      }else{
        itoa_r_record = c(itoa_r_record,0)
      }
    }else{
      itoa_r_record = c(itoa_r_record,NA)
    }
    
  }
  
  if (t>rthresh){
    if (!is.na(atoi_r_record[t-rthresh])){
       if (atoi_r_record[t-rthresh]==1){
         p_i_voc = max(.002,min(.2,p_i_voc*100))
         
       } 
    }
  }
  
}

print(i_voc_record[1:(5*60)])
print(paste("total infant vocalization count: ",sum(i_voc_record)))
print(a_voc_record[1:(5*60)])
print(paste("total adult vocalization count: ",sum(a_voc_record)))

print(paste("response window: ",rthresh))

atoi_r_count = sum(atoi_r_record,na.rm=TRUE)
print(atoi_r_record[1:(5*60)])
print(paste("total adult response to infant count:",atoi_r_count))

itoa_r_count = sum(itoa_r_record,na.rm=TRUE)
print(itoa_r_record[1:(5*60)])
print(paste("total infant response to adult count:",itoa_r_count))
```

## Which infant vocalizations were followed by adult responses?

Calculate how many infant vocalizations were followed within rthresh s by an adult vocalization

```{r}
atoi_r_record = c()
for (t in 1:(sim_length-rthresh)){
  if (i_voc_record[t] == 1){
    if (sum(a_voc_record[(t+1):(t+rthresh)])>0){
      atoi_r_record = c(atoi_r_record,1)
    }else{
      atoi_r_record = c(atoi_r_record,0)
    }
  }else{
    atoi_r_record = c(atoi_r_record,NA)
  }
}
atoi_r_count = sum(atoi_r_record,na.rm=TRUE)
print(paste("response window: ",rthresh))
print(atoi_r_record[1:(5*60)])
print(paste("total adult response to infant count:",atoi_r_count))
```

## Which adult vocalizations were followed by infant responses?

```{r}
itoa_r_record = c()
for (t in 1:(sim_length-rthresh)){
  if (a_voc_record[t] == 1){
    if (sum(i_voc_record[(t+1):(t+rthresh)])>0){
      itoa_r_record = c(itoa_r_record,1)
    }else{
      itoa_r_record = c(itoa_r_record,0)
    }
  }else{
    itoa_r_record = c(itoa_r_record,NA)
  }
}
itoa_r_count = sum(itoa_r_record,na.rm=TRUE)
print(paste("response window: ",rthresh))
print(itoa_r_record[1:(5*60)])
print(paste("total infant response to count:",itoa_r_count))
```

## Get infant inter-vocalization intervals and whether they are with response or without response steps, and the median and 90th percentile values for the wr and wor steps. Exclude steps (setting wr to NA in those cases) where the infant ivi was <= rthresh (because then the adult couldn't have responded, because they were restricted from overlapping an infant voc).
```{r}
i_ivi_record = c()
i_ivi_wr_record = c()
i1 = NA
i2 = NA
for (t in 1:sim_length){
  if (is.na(i1) & i_voc_record[t]==1){
    i1 = t
  } else if (i_voc_record[t]==1){
    
    i2 = t
    ivi = i2-i1
    i_ivi_record = c(i_ivi_record,ivi)
    
    if (ivi<=rthresh){
      i_ivi_wr_record = c(i_ivi_wr_record,NA)
    }else if (atoi_r_record[i1]==1){
      i_ivi_wr_record = c(i_ivi_wr_record,1)
    }else{
      i_ivi_wr_record = c(i_ivi_wr_record,0)
    }
    
    i1 = i2
  }
}
print(i_ivi_record[1:(5*60)])
print(i_ivi_wr_record[1:(5*60)])
i_ivi_minlength_record = i_ivi_record[i_ivi_record>rthresh+1]
i_ivi_minlength_wr_record = i_ivi_wr_record[i_ivi_record>rthresh+1]
i_ivi_wr_median = median(i_ivi_minlength_record[i_ivi_minlength_wr_record==1])
i_ivi_wor_median = median(i_ivi_minlength_record[i_ivi_minlength_wr_record!=1])
i_ivi_wr_90pct = quantile(i_ivi_minlength_record[i_ivi_minlength_wr_record==1],probs=.9,na.rm=TRUE)
i_ivi_wor_90pct = quantile(i_ivi_minlength_record[i_ivi_minlength_wr_record!=1],probs=.9,na.rm=TRUE)
print(i_ivi_wr_median)
print(i_ivi_wor_median)
print(i_ivi_wr_90pct)
print(i_ivi_wor_90pct)
```

## Perform uncontrolled analysis testing whether WR IVIs are shorter than WOR IVIs
```{r}
i_ivi_wr_fit = lm(scale(i_ivi_record)~i_ivi_wr_record)
summary(i_ivi_wr_fit)
i_ivi_wr_log_fit = lm(scale(log(i_ivi_record))~i_ivi_wr_record)
summary(i_ivi_wr_log_fit)
```

## Find and plot the relationship between the current infant IVI and the previous infant IVI
```{r}
n_i_ivi = length(i_ivi_record)
plot(log(i_ivi_record[1:n_i_ivi-1]),log(i_ivi_record[2:n_i_ivi]))
i_ivi_fit = lm(scale(log(i_ivi_record[2:n_i_ivi]))~scale(log(i_ivi_record[1:n_i_ivi-1])))
#i_ivi_fit = lm(scale(log(i_ivi_record[4:n_i_ivi]))~scale(log(i_ivi_record[1:(n_i_ivi-3)]))+scale(log(i_ivi_record[2:(n_i_ivi-2)]))+scale(log(i_ivi_record[3:(n_i_ivi-1)])))
abline(i_ivi_fit)
summary(i_ivi_fit)
```

## Get the residuals of of that fit, indicating if the current infant IVI is longer or shorter than expected given the previous infant IVI
```{r}
i_ivi_res = resid(i_ivi_fit)
```

# See if the residuals of the prediction of current IVI based on previous IVI show a pattern where wr IVIs are shorter than wor IVIs controlling for the persistence of IVI
```{r}
i_ivi_res_fit = lm(scale(i_ivi_res[1:length(i_ivi_res-1)])~scale(i_ivi_wr_record[2:length(i_ivi_wr_record-1)]),na.action=na.omit)
#i_ivi_res_fit = lm(scale(i_ivi_res[1:length(i_ivi_res-1)])~scale(i_ivi_wr_record[4:length(i_ivi_wr_record-1)]),na.action=na.omit)
summary(i_ivi_res_fit)